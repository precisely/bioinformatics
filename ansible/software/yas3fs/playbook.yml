---
- name: install FUSE
  apt:
    name:
      - fuse
      - python-pip

- name: install yas3fs
  pip:
    executable: /usr/bin/pip2
    name:
      - yas3fs

- name: enable non-root FUSE mounts
  lineinfile:
    path: /etc/fuse.conf
    regexp: "#user_allow_other"
    state: present
    line: "user_allow_other"

- name: make S3 mount point
  file:
    path: /data-s3
    state: directory
    mode: '0777'

- name: add yas3fs shutdown script
  copy:
    src: "files/unmount-yas3fs.init.d"
    dest: "/root/unmount-yas3fs"
    mode: u+x,g+x,o+x

- name: add yas3fs shutdown systemd service
  copy:
    src: "files/unmount-yas3fs.service"
    dest: "/etc/systemd/system/unmount-yas3fs.service"

- name: enable yas3fs unmount service
  command: "systemctl enable unmount-yas3fs"
